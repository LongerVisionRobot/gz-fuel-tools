#!/usr/bin/ruby

# Copyright (C) 2017 Open Source Robotics Foundation
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

# We use 'dl' for Ruby <= 1.9.x and 'fiddle' for Ruby >= 2.0.x
if RUBY_VERSION.split('.')[0] < '2'
  require 'dl'
  require 'dl/import'
  include DL
else
  require 'fiddle'
  require 'fiddle/import'
  include Fiddle
end

require 'optparse'

# Constants.
LIBRARY_NAME = '@IGN_LIBRARY_NAME@'
LIBRARY_VERSION = '@PROJECT_VERSION_FULL@'
COMMON_OPTIONS =
               "  -h [ --help ]              Print this help message.\n"\
               "                                                    \n"        +
               "  --force-version <VERSION>  Use a specific library version.\n"\
               "                                                    \n"        +
               '  --versions                 Show the available versions.'

COMMANDS = { 'fuel' =>
  "Manage simulation resources.                                            \n"\
  "  ign fuel [action] [options]                                           \n"\
  "                                                                        \n"\
  "Available Actions:                                                      \n"\
  "  list                     List available models                        \n"\
  "  locate                   Print location on disk, downloading if needed\n"\
  "  pull                     Download a model                             \n"\
  "  push                     Upload a model                               \n"\
  "                                                                        \n"\
  "Available Options:                                                      \n" +
  COMMON_OPTIONS
}

SUBCOMMANDS = { 'list' =>
  "List simulation resources                                               \n"\
  "  ign fuel list [options]                                               \n"\
  "                                                                        \n"\
  "Available Options:                                                      \n"\
  "  --owner OWNER            Owner of the resource                        \n"\
  "  --name NAME              Name of the resource                         \n"\
  "  --url URL                URL of a server the resource comes from      \n"\
  "                                                                        \n"\
  "Available Options:                                                      \n" +
  COMMON_OPTIONS,
                'locate' =>
  "Locate where a resource is on disk, fetching if necessary               \n"\
  "  ign fuel locate [options]                                             \n"\
  "                                                                        \n"\
  "Required Flags:                                                         \n"\
  "  --name NAME              Name of the resource                         \n"\
  "                                                                        \n"\
  "Available Options:                                                      \n"\
  "  --owner OWNER            Owner of the resource                        \n"\
  "  --url URL                URL of a server the resource comes from      \n" +
  COMMON_OPTIONS,
                'push' =>
  "Upload simulation resources                                             \n"\
  "  ign fuel push [options] --url URL --owner OWNER --name NAME --path PATH\n"\
  "                                                                        \n"\
  "Required Flags:                                                         \n"\
  "  --owner OWNER            Owner of the resource                        \n"\
  "  --name NAME              Name of the resource                         \n"\
  "  --url URL             URL of a server the resource comes from         \n"\
  "  --path PATH           PATH to resource on disk                        \n"\
  "                                                                        \n"\
  "Available Options:                                                      \n" +
  COMMON_OPTIONS,
                'pull' =>
  "Download simulation resources                                           \n"\
  "  ign fuel pull [options] --url URL --owner OWNER --name NAME           \n"\
  "                                                                        \n"\
  "Required Flags:                                                         \n"\
  "  --owner OWNER            Owner of the resource                        \n"\
  "  --name NAME              Name of the resource                         \n"\
  "                                                                        \n"\
  "Available Options:                                                      \n"\
  "  --url URL             URL of a server the resource comes from         \n" +
  COMMON_OPTIONS,
                'hello' =>
  "check if library is working                                             \n"\
  "Available Options:                                                      \n" +
  COMMON_OPTIONS,
}

#
# Class for the Ignition Fuel command line tools.
#
class Cmd

  #
  # Return a structure describing the options.
  #
  def parse(args)
    options = {
      'url' => '',
      'path' => '',
      'owner' => '',
      'name' => '',
      'verbose' => 0,
    }

    usage = COMMANDS[args[0]]

    if !SUBCOMMANDS.key?(args[1])
      puts usage
      exit -1
    else
      usage = SUBCOMMANDS[args[1]]
    end

    opt_parser = OptionParser.new do |opts|
      opts.banner = usage

      opts.on('-h', '--help') do
        puts usage
        exit
      end
      opts.on('--url SERVER') do |server|
        options['url'] = server
      end
      opts.on('--owner OWNER') do |owner|
        options['owner'] = owner
      end
      opts.on('--name NAME') do |name|
        options['name'] = name
      end
      opts.on('--path NAME') do |path|
        options['path'] = path
      end
      opts.on('-v LEVEL', '--verbose LEVEL', OptionParser::DecimalInteger) do |level|
        options['verbose'] = level
      end
    end # opt_parser do

    opt_parser.parse!(args)

    options['command'] = args[0]
    options['subcommand'] = args[1]

    # check required flags
    case options['subcommand']
    when 'list'
      # no required flags
    end

    options
  end # parse()

  def execute(args)
    options = parse(args)

    # Read the plugin that handles the command.
    plugin = LIBRARY_NAME
    conf_version = LIBRARY_VERSION

    begin
      Importer.dlload plugin
    rescue DLError
      puts "Library error: [#{plugin}] not found."
      exit(-1)
    end

    # Read the library version.
    Importer.extern 'char* ignitionVersion()'
    begin
      plugin_version = Importer.ignitionVersion.to_s
    rescue DLError
      puts "Library error: Problem running 'ignitionVersion()' from #{plugin}."
      exit(-1)
    end

    # Sanity check: Verify that the version of the yaml file matches the version
    # of the library that we are using.
    unless plugin_version.eql? conf_version
      puts "Error: Version mismatch. Your configuration file version is
            [#{conf_version}] but #{plugin} version is [#{plugin_version}]."
      exit(-1)
    end

    begin
      case options['subcommand']
      when 'list'
        Importer.extern 'void listModels()'
        Importer.listModels
      end
    rescue
      puts "Library error: Problem running [#{options['command']}]() "\
           "from @IGN_LIBRARY_NAME@."
    end # begin
  end # execute
end # class
